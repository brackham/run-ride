<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <style>

  body {
    margin: 0;
    padding: 500px 0;
    font-family: "Helvetica neue";
  }

  #poster {
    /*A3 Width: 3508px */
    width: 3484px; 
    /*A3 Height: 4950px */
    height: 4926px;
    margin: 0 auto;
    border: 1px solid #000;
    display: block;
    padding: 12px;
    position: relative;
  }

  .arc {
    fill: none;
    stroke: #222;
    stroke-width: 4px;
    stroke-linecap: round;
  }

  div {
    display: inline-block;
    margin: 0 30px 68px;
    padding: 0;
  }

  text {
    font-style: italic;
    font-family: 'Times New Roman';
    font-size: 1.8em;
  }

  #footer {
    display: block;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    text-align: center;
    margin: 0;
  }

  h1 {
    text-align: left;
    font-size: 7em;
    line-height: 135%;
    margin: 0 0 10px;
  }

  #footer ul {
    display: inline-block;
    list-style: none;
    margin: 0;
    padding: 0;
    vertical-align: top;
  }

  svg.run-stats {
    width: 701px;
    display: inline-block;
    height: 37px;
    padding: 8px 0 0;
  }

  .run-stats text {
    font-style: normal;
    font-family: 'Times New Roman';
    font-size: 2em;
  }

  p {
    margin: 0 0 5px;
    line-height: 135%;
  }

  </style>
</head>
<body>
  <div id="poster">
    <div id="footer"></div>
  </div>

  <!-- Javascript -->
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="libs/moment.js"></script>
  <script>

  // Set vars
  var runs = ["2013-06-25-1819.gpx.geojson", "2013-07-15-1757.gpx.geojson", "2013-09-10-1851.gpx.geojson", "2013-09-12-1839.gpx.geojson", "2013-10-01-0648.gpx.geojson", "2013-10-03-0647.gpx.geojson", "2013-10-07-0715.gpx.geojson", "2013-10-09-0704.gpx.geojson", "2013-10-14-0705.gpx.geojson", "2013-10-15-1607.gpx.geojson", "2013-10-17-1640.gpx.geojson", "2013-10-22-0703.gpx.geojson", "2013-10-29-0701.gpx.geojson", "2013-11-04-0703.gpx.geojson", "2013-11-08-0710.gpx.geojson", "2013-11-12-0701.gpx.geojson", "2013-11-19-0702.gpx.geojson", "2013-12-07-1203.gpx.geojson", "2013-12-23-0759.gpx.geojson", "2013-12-24-0855.gpx.geojson", "2013-12-28-1200.gpx.geojson", "2013-12-29-0951.gpx.geojson", "2013-12-31-1036.gpx.geojson", "20130302-135810-Ride.gpx.geojson", "20130316-090035-Ride.gpx.geojson", "20130406-092005-Ride.gpx.geojson", "20130407-085909-Ride.gpx.geojson", "20130408-162556-Ride.gpx.geojson", "20130409-162721-Ride.gpx.geojson", "20130410-162424-Ride.gpx.geojson", "20130413-072211-Ride.gpx.geojson", "20130414-085310-Ride.gpx.geojson", "20130415-163346-Ride.gpx.geojson", "20130419-163301-Ride.gpx.geojson", "20130420-072630-Ride.gpx.geojson", "20130504-110849-Ride.gpx.geojson", "20130506-080333-Ride.gpx.geojson", "20130508-065841-Ride.gpx.geojson", "20130508-163122-Ride.gpx.geojson", "20130519-085701-Ride.gpx.geojson", "20130602-113548-Ride.gpx.geojson", "20130611-131745-Run.gpx.geojson", "20130625-172056-Ride.gpx.geojson", "20130625-180310-Ride.gpx.geojson", "20130701-164233-Ride.gpx.geojson", "20130702-175443-Run.gpx.geojson", "20130708-175837-Ride.gpx.geojson", "20130708-180741-Run.gpx.geojson", "20130709-174932-Run.gpx.geojson", "20130710-164102-Ride.gpx.geojson", "20130712-183013-Run.gpx.geojson", "20130713-065417-Ride.gpx.geojson", "20130715-171806-Ride.gpx.geojson", "20130721-101113-Ride.gpx.geojson", "20130722-183813-Run.gpx.geojson", "20130724-192606-Run.gpx.geojson", "20130726-171728-Ride.gpx.geojson", "20130729-180015-Run.gpx.geojson", "20130801-185807-Ride.gpx.geojson", "20130803-054758-Ride.gpx.geojson", "20130805-181031-Run.gpx.geojson", "20130808-180441-Run.gpx.geojson", "20130819-185157-Run.gpx.geojson", "20130820-175120-Ride.gpx.geojson", "20130827-174035-Ride.gpx.geojson", "20130828-183601-Run.gpx.geojson", "20130901-065608-Ride.gpx.geojson", "20130902-184834-Run.gpx.geojson"];

  var width = 375,
      height = 375;

  var poster = document.getElementById("poster");
  var poster_footer = document.getElementById("footer");
  var runInfo = [];

  // Add Title
  addTitle("2013 Run & Ride");
  var posterTitle = document.getElementById("title");

  // Add Runs
  for (var i=0;i<runs.length;i++){
    d3.json("data/"+runs[i], function(error, run) {
      drawRun(run); //load the json data
    });
  };

  // Functions
  function drawRun(runData, i){
    var runDiv = document.createElement("div");
    runDiv.className = "run";
    runDiv.dataset.runDate = runData.features[0].properties.time;
    runDiv.dataset.runDistance = totalDistance(runData).toFixed(2);

    poster.appendChild(runDiv);

    var projection = d3.geo.mercator()
        .scale(1)
        .translate([0, 0]);

    var path = d3.geo.path()
        .projection(projection);

    // Compute the bounds of a feature of interest, then derive scale & translate.
    var b = path.bounds(runData),
        s = .80 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
        t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

    // Update the projection to use computed scale & translate.
    projection
      .scale(s)
      .translate(t);

    var svg = d3.select(runDiv).append("svg")
      .attr("class", "run-svg" )
      .attr("width", width)
      .attr("height", height);

    svg.append("path")
      .datum(runData)
      .attr("class", "arc")
      .attr("d", path);

    svg.append("text")
       .attr("x", 0)
       .attr("y", 365);
    
    var legend = d3.select(poster_footer).append("svg")
      .attr('data-run-date', runData.features[0].properties.time)
      .attr('data-run-distance', totalDistance(runData).toFixed(2))
      .attr("class", "run-stats" );

    legend.append("text")
       .attr("x", 0)
       .attr("y", 35);   

    // Sort the divs
    sortMaps();
    sortStats();
  }

  function formattedDate(datetime){
    var date = new Date(datetime);
    var curr_date = date.getDate(),
        curr_month = date.getMonth() + 1, //Months are zero based
        curr_year = date.getFullYear();
    document.write(curr_date + "-" + curr_month + "-" + curr_year);
  }

  function sortMaps(){
    var runDivs = document.getElementsByClassName("run");
    var runs = [];

    for (var i = 0; i < runDivs.length; ++i) {
      runs.push(runDivs[i]);
    }

    runs.sort(function(a, b) {
      return a.dataset.runDate.localeCompare(b.dataset.runDate);
    })

    runs.forEach(function(run, index) {
      poster.appendChild(run);
      var string = "Fig. " + (index + 1);
      var legend = d3.selectAll('div.run[data-run-date="' + run.dataset.runDate + '"]')
                     .select('text')
                     .text(string);
    });
  }

  Array.prototype.chunk = function ( n ) {
    if ( !this.length ) {
      return [];
    }
    return [ this.slice( 0, n ) ].concat( this.slice(n).chunk(n) );
  };

  function sortStats(){
    var runDivs = document.getElementsByClassName("run-stats");

    if(runDivs.length == 68){
      var runs = [];
      for (var i = 0; i < runDivs.length; ++i) {
        runs.push(runDivs[i]);
      }

      runs.sort(function(a, b) {
        return a.dataset.runDate.localeCompare(b.dataset.runDate);
      })

      var chunks = runs.chunk(14);
      var ulCount = 0;

      chunks.forEach(function(chunk, index) {
        var ul = document.createElement("ul");
        ul.className = "stats_" + index;
        poster_footer.appendChild(ul);

        chunk.forEach(function(run, index) {
          var li = document.createElement("li");
          li.appendChild(run);
          ul.appendChild(li);

          var date = run.dataset.runDate;
          var distance = run.dataset.runDistance;
          var date = moment(date).format('DD/MM/YYYY hh:mma');    
          var string = "Fig. " + ((ulCount*14)+(index + 1)) + ": " + date + " - " + distance + "km";

          var legend = d3.selectAll('svg.run-stats[data-run-date="' + run.dataset.runDate + '"]')
                         .select('text')
                         .text(string);
        });

        ulCount++;
      });      
    };
  }

  function insertAfter(referenceNode, newNode) {
    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
  }

  function addTitle(title) {
    var el = document.createElement("h1");
    el.id = "title";
    el.innerHTML = title;

    poster_footer.appendChild(el);
  }

  function footerEl(index, date, distance){
    var el = document.createElement("p");
    el.className = "run-detail";
    el.dataset.runDate = date;
    el.dataset.runDistance = distance;
    insertAfter(posterTitle, el);

    return el;
  }

  function totalDistance(data){
    var coords = data.features[0].geometry.coordinates;
    var totalDist = 0;

    for (var i = 0; i < (coords.length-1); ++i) {
      var p1 = [coords[i][0], coords[i][1]]
      var p2 = [coords[i+1][0], coords[i+1][1]]
          
      totalDist += calcDist(p1, p2);
    }

    return totalDist;
  }

  function calcDist(p1, p2) {
    // Haversine formula
    dLatRad = Math.abs(p1[1] - p2[1]) * Math.PI/180;
    dLonRad = Math.abs(p1[0] - p2[0]) * Math.PI/180;
    // Calculate origin in Radians
    lat1Rad = p1[1] * Math.PI/180;
    lon1Rad = p1[0] * Math.PI/180;
    // Calculate new point in Radians
    lat2Rad = p2[1] * Math.PI/180;
    lon2Rad = p2[0] * Math.PI/180;

    // Earth's Radius
    eR = 6371;
    d1 = Math.sin(dLatRad/2) * Math.sin(dLatRad/2) +
         Math.sin(dLonRad/2) * Math.sin(dLonRad/2) * Math.cos(lat1Rad) * Math.cos(lat2Rad);
    d2 = 2 * Math.atan2(Math.sqrt(d1), Math.sqrt(1-d1));
    return(eR * d2);
  }

  d3.select(self.frameElement).style("height", height + "px");

  </script>
</body>